<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Cliente - Smart Passes</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn-logout {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-logout:hover {
            background: white;
            color: #11998e;
        }
        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 30px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .stat-card h3 {
            color: #999;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .stat-card .number {
            font-size: 36px;
            font-weight: 700;
            color: #11998e;
        }
        .section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .section h2 {
            font-size: 22px;
            margin-bottom: 20px;
            color: #333;
        }
        .btn-primary {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
        }
        .api-key-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn-copy {
            background: #11998e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        .btn-copy:hover {
            background: #0d7a6f;
        }
        .clases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .clase-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .clase-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .clase-card .tipo {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .clase-card .class-id {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            opacity: 0.8;
            margin-top: 10px;
            word-break: break-all;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal h2 {
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #11998e;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
        }
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        .loading {
            display: none;
            text-align: center;
            color: #999;
            margin-top: 20px;
        }
        .success-msg, .error-msg {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .success-msg {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .error-msg {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1><span>üé´</span> <span id="nombreNegocio">Mi Negocio</span></h1>
            <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Pases Creados</h3>
                <div class="number" id="totalPases">0</div>
            </div>
            <div class="stat-card">
                <h3>Clases Creadas</h3>
                <div class="number" id="totalClases">0</div>
            </div>
            <div class="stat-card">
                <h3>Pases Activos</h3>
                <div class="number" id="pasesActivos">0</div>
            </div>
        </div>

        <div class="section">
            <h2>API Key</h2>
            <p style="color: #666; margin-bottom: 10px;">Usa esta clave para crear pases mediante la API</p>
            <div class="api-key-box">
                <code id="apiKeyDisplay">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</code>
                <button class="btn-copy" onclick="copyApiKey()">Copiar</button>
            </div>
        </div>

        <div class="section">
            <h2>Mis Clases de Google Wallet</h2>
            <button class="btn-primary" onclick="openCreateClaseModal()">‚ûï Crear Nueva Clase</button>

            <div id="clasesContainer" class="clases-grid"></div>
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="icon">üì¶</div>
                <h3>No tienes clases creadas</h3>
                <p>Crea tu primera clase de Google Wallet para empezar a generar pases</p>
            </div>
        </div>
    </div>

    <!-- Modal Crear Clase -->
    <div class="modal" id="createClaseModal">
        <div class="modal-content">
            <h2>Crear Nueva Clase</h2>

            <div class="success-msg" id="successMsg"></div>
            <div class="error-msg" id="errorMsg"></div>

            <form id="createClaseForm">
                <div class="form-group">
                    <label>Tipo de Pase *</label>
                    <select id="tipoPase" required>
                        <option value="">Selecciona un tipo</option>
                        <option value="generic">üé´ Gen√©rico</option>
                        <option value="loyalty">‚≠ê Lealtad</option>
                        <option value="offer">üéÅ Oferta/Cup√≥n</option>
                        <option value="giftcard">üí≥ Tarjeta de Regalo</option>
                        <option value="eventticket">üéüÔ∏è Boleto de Evento</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Nombre de la Clase *</label>
                    <input type="text" id="nombreClase" placeholder="ej: membresia-gym" required>
                    <small style="color: #999;">Solo letras, n√∫meros y guiones</small>
                </div>

                <div class="form-group">
                    <label>Nombre del Emisor *</label>
                    <input type="text" id="issuerName" placeholder="Mi Negocio" required>
                </div>

                <div class="form-group">
                    <label>Color de Fondo</label>
                    <input type="color" id="colorFondo" value="#4285F4">
                </div>

                <div class="form-group">
                    <label>URL del Logo</label>
                    <input type="url" id="logoUrl" placeholder="https://example.com/logo.png">
                </div>

                <div class="form-group">
                    <label>URL Hero Image</label>
                    <input type="url" id="heroUrl" placeholder="https://example.com/hero.jpg">
                </div>

                <div class="loading" id="loading">Creando clase en Google Wallet...</div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeCreateClaseModal()">Cancelar</button>
                    <button type="submit" class="btn-primary" style="flex: 1;">Crear Clase</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://smart-passes-api.smartpasses.workers.dev';
        let clienteData = {};
        let clasesData = [];

        // Verificar sesi√≥n al cargar
        window.addEventListener('DOMContentLoaded', async () => {
            const sessionId = localStorage.getItem('sessionId');
            const userType = localStorage.getItem('userType');

            if (!sessionId || userType !== 'cliente') {
                window.location.href = 'cliente-login.html';
                return;
            }

            await loadDashboard();
        });

        async function loadDashboard() {
            const sessionId = localStorage.getItem('sessionId');

            try {
                const response = await fetch(`${API_URL}/cliente/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    clienteData = data.cliente;
                    clasesData = data.clases;

                    // Actualizar UI
                    document.getElementById('nombreNegocio').textContent = clienteData.nombre_negocio;
                    document.getElementById('apiKeyDisplay').textContent = clienteData.api_key;
                    document.getElementById('totalPases').textContent = clienteData.estadisticas.pases_creados;
                    document.getElementById('totalClases').textContent = clienteData.estadisticas.clases_creadas;
                    document.getElementById('pasesActivos').textContent = clienteData.estadisticas.pases_activos;

                    renderClases();
                } else {
                    alert('Error al cargar dashboard');
                    window.location.href = 'cliente-login.html';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            }
        }

        function renderClases() {
            const container = document.getElementById('clasesContainer');
            const emptyState = document.getElementById('emptyState');

            if (clasesData.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            emptyState.style.display = 'none';

            const tiposIconos = {
                'generic': 'üé´',
                'loyalty': '‚≠ê',
                'offer': 'üéÅ',
                'giftcard': 'üí≥',
                'eventticket': 'üéüÔ∏è'
            };

            container.innerHTML = clasesData.map(clase => `
                <div class="clase-card">
                    <h3>
                        <span>${tiposIconos[clase.tipo] || 'üé´'}</span>
                        <span>${clase.nombre}</span>
                    </h3>
                    <div class="tipo">${clase.tipo.toUpperCase()}</div>
                    <div class="class-id">${clase.id}</div>
                </div>
            `).join('');
        }

        function copyApiKey() {
            const apiKey = clienteData.api_key;
            navigator.clipboard.writeText(apiKey);

            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úì Copiado';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        }

        function openCreateClaseModal() {
            document.getElementById('createClaseModal').classList.add('active');
            document.getElementById('createClaseForm').reset();
            document.getElementById('successMsg').style.display = 'none';
            document.getElementById('errorMsg').style.display = 'none';
        }

        function closeCreateClaseModal() {
            document.getElementById('createClaseModal').classList.remove('active');
        }

        document.getElementById('createClaseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const sessionId = localStorage.getItem('sessionId');
            const loading = document.getElementById('loading');
            const successMsg = document.getElementById('successMsg');
            const errorMsg = document.getElementById('errorMsg');

            loading.style.display = 'block';
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';

            const datos = {
                tipo: document.getElementById('tipoPase').value,
                nombre_clase: document.getElementById('nombreClase').value,
                config: {
                    issuer_name: document.getElementById('issuerName').value,
                    color_fondo: document.getElementById('colorFondo').value,
                    logo_url: document.getElementById('logoUrl').value || null,
                    hero_url: document.getElementById('heroUrl').value || null,
                    webhook_url: `${API_URL}/webhook/wallet-events`
                }
            };

            try {
                const response = await fetch(`${API_URL}/cliente/crear-clase`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datos)
                });

                const data = await response.json();
                loading.style.display = 'none';

                if (data.success) {
                    successMsg.textContent = '‚úÖ Clase creada exitosamente';
                    successMsg.style.display = 'block';

                    setTimeout(async () => {
                        closeCreateClaseModal();
                        await loadDashboard();
                    }, 1500);
                } else {
                    errorMsg.textContent = data.error || 'Error al crear clase';
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                loading.style.display = 'none';
                errorMsg.textContent = 'Error de conexi√≥n';
                errorMsg.style.display = 'block';
            }
        });

        function logout() {
            localStorage.clear();
            window.location.href = 'cliente-login.html';
        }
    </script>
</body>
</html>
